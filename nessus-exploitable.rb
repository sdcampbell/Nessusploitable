#! /usr/bin/env ruby

require 'optparse'
require 'ruby-nessus'

time = Time.new

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: nessus-exploitable.rb [options] [path]"
  opts.on('-f', '--file PATH', 'File path for a single file') { |v| options[:file_path] = v }
  opts.on('-d', '--directory PATH', 'Directory path to import multiple .nessus files') { |v| options[:dir_path] = v }
  opts.on('-h', '--help', "Prints help") do
    puts "Ruby Nessus - Parses Nessus .nessus files for exploitable vulnerabilities and outputs a report file in format MM-DD-YYYY-nessus.csv"
    puts "Import the report data into Excel in Tab Separated Values format."
    puts "Author: Steve Campbell, @lpha3ch0"
    puts opts
    exit
  end

end.parse!

if options[:dir_path]
  File.open("#{time.month}-#{time.day}-#{time.year}-nessus.csv", 'w') do |file|
    file.puts "Risk\tHost IP\tHostname\tPort\tName\tMetasploit Module\tReferences"
    Dir.glob("#{options[:dir_path]}/*.nessus").each do |n|
      ness = RubyNessus::Parse.new(n)
      ness.scan.each_host do |host|
        host.each_event do |event|
          if event.exploitability_ease == "No exploit is required"
            file.puts "#{event.risk}\t#{host.ip}\t#{host.hostname}\t#{event.port}\t#{event.name}\t#{event.metasploit_name}\t#{event.see_also}"
          elsif event.exploitability_ease == "Exploits are available"
            file.puts "#{event.risk}\t#{host.ip}\t#{host.hostname}\t#{event.port}\t#{event.name}\t#{event.metasploit_name}\t#{event.see_also}"
          end
        end
      end
    end
  end
elsif options[:file_path]
  File.open("#{time.day}-#{time.month}-#{time.year}-nessus.csv", 'w') do |file|
    file.puts "Risk\tHost IP\tHostname\tPort\tName\tMetasploit Module\tReferences"
    ness = RubyNessus::Parse.new("#{options[:file_path]}")
    ness.scan.each_host do |host|
      host.each_event do |event|
        if event.exploitability_ease == "No exploit is required"
          file.puts "#{event.risk}\t#{host.ip}\t#{host.hostname}\t#{event.port}\t#{event.name}\t#{event.metasploit_name}\t#{event.see_also}"
        elsif event.exploitability_ease == "Exploits are available"
          file.puts "#{event.risk}\t#{host.ip}\t#{host.hostname}\t#{event.port}\t#{event.name}\t#{event.metasploit_name}\t#{event.see_also}"
        end
      end
    end
  end
end
